jupyter nbconvert --to markdown spark_03.ipynb
```python
from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("example2").getOrCreate()
```

    Setting default log level to "WARN".
    To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
    23/10/13 18:15:22 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable



```python
# DataSet : 정적 데이터 타입(ex_자바,스칼라)를 지원하기 위해 고안된 스파크의 구조적 
'''
DataFrame은 다양한 데이터 타입의 테이블형 데이터를 보관할 수 있는 Row 타이브이 객체로 구성된 분산 컬렉션
DataSet API는 DataFrame의 레코드를 사용자가 자바나 ㅅ칼라로 정의한 클래스에 할당하고, 자바의 ArrayList나 스칼라의 Seq 객체 등의 고정 타입형 컬렉션으로 다룰 수 있는 기능으 ㄹ젝ㅇ한다.

'''
```




    '\nDataFrame은 다양한 데이터 타입의 테이블형 데이터를 보관할 수 있는 Row 타이브이 객체로 구성된 분산 컬렉션\nDataSet API는 DataFrame의 레코드를 사용자가 자바나 스칼라로 정의한 클래스에 할당하고, 자바의 ArrayList나 스칼라의 Seq 객체 등의 고정 타입형 컬렉션으로 다룰 수 있는 기능으 제공한다.\n\n'




```python
staticDataFrame=spark.read.format("csv") \
    .option("header","true")\
        .option("inferSchema","true")\
            .load("/opt/spark/data/book-data/retail-data/by-day/*.csv")

staticDataFrame.createOrReplaceTempView("retail_data")
staticSchema=staticDataFrame.schema
```

                                                                                    


```python
# 구매비용 컬럼을 추가하고 고객이 가장 소비 많이 한 날을 찾음 
from pyspark.sql.functions import window, column, desc, col
staticDataFrame\
  .selectExpr(
    "CustomerId",
    "(UnitPrice * Quantity) as total_cost",
    "InvoiceDate")\
  .groupBy(
    col("CustomerId"), window(col("InvoiceDate"), "1 day"))\
  .sum("total_cost")\
  .show(5)

# window 함수 : 집계 시에 시계열 컬럼을 기준으로 각 날짜에 대한 전체 데이터를 가지는 윈도우를 거성
```

    [Stage 7:=====================>                                  (29 + 48) / 77]

    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   16057.0|{2011-12-05 09:00...|             -37.6|
    |   14126.0|{2011-11-29 09:00...| 643.6300000000001|
    |   13500.0|{2011-11-16 09:00...| 497.9700000000001|
    |   15156.0|{2011-12-05 09:00...|391.46000000000004|
    |   17144.0|{2011-12-08 09:00...|388.68000000000006|
    +----------+--------------------+------------------+
    only showing top 5 rows
    


                                                                                    


```python
spark.conf.set("spark.sql.shuffle.partitions","5")
```


```python
# 스트리밍 코드
streamingDataFrame=spark.readStream\
.schema(staticSchema)\
.option("maxFilesPerTrigger",1)\
.format("csv")\
.option("header","true")\
.load("/opt/spark/data/book-data/retail-data/by-day/*.csv")
```

                                                                                    


```python
streamingDataFrame.isStreaming
```




    True




```python
purchaseByCustomerPerHour=streamingDataFrame\
.selectExpr(
  "CustomerId",
    "(UnitPrice * Quantity) as total_cost",
    "InvoiceDate")\
    .groupBy(
col("CustomerId"),window(col("InvoiceDate"),"1 day"))\
.sum("total_cost")

# 이 작업은 지연연산이므로 스트리밍 액션을 호출해야한다.
    
```


```python
purchaseByCustomerPerHour.writeStream\
.format("memory")\
.queryName("customer_purchases")\
.outputMode("complete")\
.start()
```

    23/10/13 18:16:45 WARN ResolveWriteToStream: Temporary checkpoint location created which is deleted normally when the query didn't fail: /tmp/temporary-3a48c1da-52a5-4079-98b8-a52cb68bea32. If it's required to delete it under any circumstances, please set spark.sql.streaming.forceDeleteTempCheckpointLocation to true. Important to know deleting temp checkpoint folder is best effort.
    23/10/13 18:16:45 WARN ResolveWriteToStream: spark.sql.adaptive.enabled is not supported in streaming DataFrames/Datasets and will be disabled.





    <pyspark.sql.streaming.query.StreamingQuery at 0x7f67e45a5f40>



                                                                                    


```python
spark.sql("""
          SELECT *
          FROM customer_purchases
        ORDER BY `sum(total_cost)`  DESC          
          """)\
.show(5)
```

    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |      NULL|{2010-12-01 09:00...|12584.299999999988|
    |   13777.0|{2010-12-01 09:00...|           6585.16|
    |   16029.0|{2010-12-01 09:00...|           3702.12|
    |   16210.0|{2010-12-01 09:00...|2474.7399999999993|
    |   12433.0|{2010-12-01 09:00...|1919.1400000000008|
    +----------+--------------------+------------------+
    only showing top 5 rows
    



```python
query=purchaseByCustomerPerHour.writeStream\
.format("console")\
.queryName("customer_purchases_2")\
.outputMode("complete")\
.start()
```

    23/10/13 18:16:55 WARN ResolveWriteToStream: Temporary checkpoint location created which is deleted normally when the query didn't fail: /tmp/temporary-035669e7-e43b-4889-9e7d-7fc9fa07b498. If it's required to delete it under any circumstances, please set spark.sql.streaming.forceDeleteTempCheckpointLocation to true. Important to know deleting temp checkpoint folder is best effort.
    23/10/13 18:16:55 WARN ResolveWriteToStream: spark.sql.adaptive.enabled is not supported in streaming DataFrames/Datasets and will be disabled.
                                                                                    

    -------------------------------------------
    Batch: 0
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   12921.0|{2010-12-01 09:00...|             322.4|
    |   16583.0|{2010-12-01 09:00...|233.45000000000002|
    |   17897.0|{2010-12-01 09:00...|            140.39|
    |   12748.0|{2010-12-01 09:00...|              4.95|
    |   15350.0|{2010-12-01 09:00...|            115.65|
    |   17809.0|{2010-12-01 09:00...|              34.8|
    |   13747.0|{2010-12-01 09:00...|              79.6|
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   15983.0|{2010-12-01 09:00...|            440.89|
    |   17511.0|{2010-12-01 09:00...|           1825.74|
    |   14001.0|{2010-12-01 09:00...|            301.24|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   18074.0|{2010-12-01 09:00...|             489.6|
    |   12868.0|{2010-12-01 09:00...|             203.3|
    |   15513.0|{2010-12-01 09:00...|             357.0|
    |   13705.0|{2010-12-01 09:00...|318.14000000000004|
    |   13694.0|{2010-12-01 09:00...|            842.12|
    |   13468.0|{2010-12-01 09:00...|360.05000000000007|
    |   13408.0|{2010-12-01 09:00...|1024.6800000000003|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    +----------+--------------------+------------------+
    only showing top 20 rows
    
    -------------------------------------------
    Batch: 1
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   14741.0|{2010-12-01 09:00...|             184.5|
    |   12748.0|{2010-12-01 09:00...|              4.95|
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   16244.0|{2010-12-02 09:00...|1056.6299999999994|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   12868.0|{2010-12-01 09:00...|             203.3|
    |   16752.0|{2010-12-02 09:00...|             207.5|
    |   13491.0|{2010-12-02 09:00...|              98.9|
    |      NULL|{2010-12-02 09:00...|431.84999999999985|
    |   14625.0|{2010-12-02 09:00...|            -37.65|
    |   13705.0|{2010-12-01 09:00...|318.14000000000004|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    |   13090.0|{2010-12-01 09:00...|             160.6|
    |   15111.0|{2010-12-02 09:00...|288.49999999999994|
    |   12921.0|{2010-12-01 09:00...|             322.4|
    |   17412.0|{2010-12-02 09:00...|             197.3|
    |   14901.0|{2010-12-02 09:00...|204.15000000000006|
    |   15922.0|{2010-12-02 09:00...|              -5.9|
    |   14865.0|{2010-12-02 09:00...|              37.2|
    |   14156.0|{2010-12-02 09:00...|              -7.5|
    +----------+--------------------+------------------+
    only showing top 20 rows
    
    -------------------------------------------
    Batch: 2
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   12748.0|{2010-12-01 09:00...|              4.95|
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   16244.0|{2010-12-02 09:00...|1056.6299999999994|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   13491.0|{2010-12-02 09:00...|              98.9|
    |   14625.0|{2010-12-02 09:00...|            -37.65|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    |   12921.0|{2010-12-01 09:00...|             322.4|
    |   14901.0|{2010-12-02 09:00...|204.15000000000006|
    |   15922.0|{2010-12-02 09:00...|              -5.9|
    |   14865.0|{2010-12-02 09:00...|              37.2|
    |   14443.0|{2010-12-02 09:00...|            -15.57|
    |   17511.0|{2010-12-01 09:00...|           1825.74|
    |   14679.0|{2010-12-03 09:00...|             -2.55|
    |   18041.0|{2010-12-02 09:00...| 428.9399999999999|
    |   13468.0|{2010-12-01 09:00...|360.05000000000007|
    |   12471.0|{2010-12-02 09:00...|             -17.0|
    |   17235.0|{2010-12-02 09:00...|             341.9|
    |   17949.0|{2010-12-03 09:00...|            1314.0|
    |   14092.0|{2010-12-02 09:00...|              -5.9|
    +----------+--------------------+------------------+
    only showing top 20 rows
    
    -------------------------------------------
    Batch: 3
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   12748.0|{2010-12-01 09:00...|              4.95|
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   16244.0|{2010-12-02 09:00...|1056.6299999999994|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   13491.0|{2010-12-02 09:00...|              98.9|
    |   16353.0|{2010-12-05 09:00...|             204.0|
    |   14625.0|{2010-12-02 09:00...|            -37.65|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    |   12921.0|{2010-12-01 09:00...|             322.4|
    |   14901.0|{2010-12-02 09:00...|204.15000000000006|
    |   15922.0|{2010-12-02 09:00...|              -5.9|
    |   14865.0|{2010-12-02 09:00...|              37.2|
    |   14800.0|{2010-12-05 09:00...| 555.8399999999999|
    |   14443.0|{2010-12-02 09:00...|            -15.57|
    |   15235.0|{2010-12-05 09:00...| 85.55000000000001|
    |   17511.0|{2010-12-01 09:00...|           1825.74|
    |   14679.0|{2010-12-03 09:00...|             -2.55|
    |   18041.0|{2010-12-02 09:00...| 428.9399999999999|
    |   13468.0|{2010-12-01 09:00...|360.05000000000007|
    |   12471.0|{2010-12-02 09:00...|             -17.0|
    +----------+--------------------+------------------+
    only showing top 20 rows
    
    -------------------------------------------
    Batch: 4
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   12748.0|{2010-12-01 09:00...|              4.95|
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   16244.0|{2010-12-02 09:00...|1056.6299999999994|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   13491.0|{2010-12-02 09:00...|              98.9|
    |   16353.0|{2010-12-05 09:00...|             204.0|
    |   14625.0|{2010-12-02 09:00...|            -37.65|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    |   15899.0|{2010-12-06 09:00...|             56.25|
    |   12921.0|{2010-12-01 09:00...|             322.4|
    |   14901.0|{2010-12-02 09:00...|204.15000000000006|
    |   15922.0|{2010-12-02 09:00...|              -5.9|
    |   14865.0|{2010-12-02 09:00...|              37.2|
    |   14825.0|{2010-12-06 09:00...|184.10000000000002|
    |   14800.0|{2010-12-05 09:00...| 555.8399999999999|
    |   14443.0|{2010-12-02 09:00...|            -15.57|
    |   15235.0|{2010-12-05 09:00...| 85.55000000000001|
    |   17511.0|{2010-12-01 09:00...|           1825.74|
    |   14679.0|{2010-12-03 09:00...|             -2.55|
    |   15078.0|{2010-12-06 09:00...| 475.1499999999999|
    +----------+--------------------+------------------+
    only showing top 20 rows
    
    -------------------------------------------
    Batch: 5
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   13491.0|{2010-12-02 09:00...|              98.9|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    |   15899.0|{2010-12-06 09:00...|             56.25|
    |   14865.0|{2010-12-02 09:00...|              37.2|
    |   14800.0|{2010-12-05 09:00...| 555.8399999999999|
    |   15235.0|{2010-12-05 09:00...| 85.55000000000001|
    |   15078.0|{2010-12-06 09:00...| 475.1499999999999|
    |   18041.0|{2010-12-02 09:00...| 428.9399999999999|
    |   12471.0|{2010-12-02 09:00...|             -17.0|
    |   17949.0|{2010-12-03 09:00...|            1314.0|
    |   17223.0|{2010-12-06 09:00...|            292.84|
    |   14829.0|{2010-12-02 09:00...|            236.97|
    |   13408.0|{2010-12-02 09:00...|            -20.85|
    |   17675.0|{2010-12-07 09:00...| 541.5200000000001|
    |   15555.0|{2010-12-05 09:00...|            198.43|
    |   18074.0|{2010-12-01 09:00...|             489.6|
    |   14396.0|{2010-12-03 09:00...|110.35000000000001|
    |   17858.0|{2010-12-05 09:00...|            251.25|
    +----------+--------------------+------------------+
    only showing top 20 rows
    
    -------------------------------------------
    Batch: 6
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   13329.0|{2010-12-08 09:00...|             304.2|
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   13491.0|{2010-12-02 09:00...|              98.9|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    |   15899.0|{2010-12-06 09:00...|             56.25|
    |   14865.0|{2010-12-02 09:00...|              37.2|
    |   14800.0|{2010-12-05 09:00...| 555.8399999999999|
    |   15235.0|{2010-12-05 09:00...| 85.55000000000001|
    |   15078.0|{2010-12-06 09:00...| 475.1499999999999|
    |   18041.0|{2010-12-02 09:00...| 428.9399999999999|
    |   12471.0|{2010-12-02 09:00...|             -17.0|
    |   12433.0|{2010-12-08 09:00...|1867.9800000000002|
    |   17949.0|{2010-12-03 09:00...|            1314.0|
    |   17223.0|{2010-12-06 09:00...|            292.84|
    |   16122.0|{2010-12-08 09:00...|            105.72|
    |   14829.0|{2010-12-02 09:00...|            236.97|
    |   13408.0|{2010-12-02 09:00...|            -20.85|
    |   17675.0|{2010-12-07 09:00...| 541.5200000000001|
    |   14744.0|{2010-12-08 09:00...|             225.0|
    +----------+--------------------+------------------+
    only showing top 20 rows
    
    -------------------------------------------
    Batch: 7
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   13329.0|{2010-12-08 09:00...|             304.2|
    |   12797.0|{2010-12-09 09:00...|            254.03|
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   15660.0|{2010-12-09 09:00...|             209.3|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   13491.0|{2010-12-02 09:00...|              98.9|
    |   13117.0|{2010-12-09 09:00...|            186.03|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    |   15899.0|{2010-12-06 09:00...|             56.25|
    |   17339.0|{2010-12-09 09:00...|              60.0|
    |   17702.0|{2010-12-09 09:00...|-88.14999999999999|
    |   17671.0|{2010-12-09 09:00...|394.18000000000006|
    |   14865.0|{2010-12-02 09:00...|              37.2|
    |   14800.0|{2010-12-05 09:00...| 555.8399999999999|
    |   15235.0|{2010-12-05 09:00...| 85.55000000000001|
    |   15078.0|{2010-12-06 09:00...| 475.1499999999999|
    |   18041.0|{2010-12-02 09:00...| 428.9399999999999|
    |   12471.0|{2010-12-02 09:00...|             -17.0|
    |   12433.0|{2010-12-08 09:00...|1867.9800000000002|
    |   17949.0|{2010-12-03 09:00...|            1314.0|
    +----------+--------------------+------------------+
    only showing top 20 rows
    
    -------------------------------------------
    Batch: 8
    -------------------------------------------
    +----------+--------------------+------------------+
    |CustomerId|              window|   sum(total_cost)|
    +----------+--------------------+------------------+
    |   13329.0|{2010-12-08 09:00...|             304.2|
    |   12797.0|{2010-12-09 09:00...|            254.03|
    |   16250.0|{2010-12-01 09:00...|            226.14|
    |   15660.0|{2010-12-09 09:00...|             209.3|
    |   17460.0|{2010-12-01 09:00...|              19.9|
    |   13491.0|{2010-12-02 09:00...|              98.9|
    |   13117.0|{2010-12-09 09:00...|            186.03|
    |   14594.0|{2010-12-01 09:00...|254.99999999999997|
    |   15899.0|{2010-12-06 09:00...|             56.25|
    |   17339.0|{2010-12-09 09:00...|              60.0|
    |   17702.0|{2010-12-09 09:00...|-88.14999999999999|
    |   17671.0|{2010-12-09 09:00...|394.18000000000006|
    |   17220.0|{2010-12-10 09:00...|317.50000000000006|
    |   14865.0|{2010-12-02 09:00...|              37.2|
    |   14800.0|{2010-12-05 09:00...| 555.8399999999999|
    |   15235.0|{2010-12-05 09:00...| 85.55000000000001|
    |   14256.0|{2010-12-10 09:00...| 523.8599999999999|
    |   15078.0|{2010-12-06 09:00...| 475.1499999999999|
    |   18041.0|{2010-12-02 09:00...| 428.9399999999999|
    |   12471.0|{2010-12-02 09:00...|             -17.0|
    +----------+--------------------+------------------+
    only showing top 20 rows
    



```python
# 스트리밍 종료
query.stop()
```

    23/10/13 18:17:05 ERROR WriteToDataSourceV2Exec: Data source write support MicroBatchWrite[epoch: 20, writer: ConsoleWriter[numRows=20, truncate=true]] is aborting.
    23/10/13 18:17:05 ERROR WriteToDataSourceV2Exec: Data source write support MicroBatchWrite[epoch: 20, writer: ConsoleWriter[numRows=20, truncate=true]] aborted.

